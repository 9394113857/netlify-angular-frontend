name: Angular CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm install

      # 4Ô∏è‚É£ Build Angular App
      - name: Build Angular App
        run: npm run build

      # 5Ô∏è‚É£ Deploy to Netlify
      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: "./dist/netlify-angular-frontend"
          production-branch: "main"
          github-token: ${{ secrets.GITHUB_TOKEN }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      # 6Ô∏è‚É£ Email on Success
      - name: Send Email Notification (Success)
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üöÄ Angular Deployment Successful ‚Äì Netlify CI/CD"
          to: "practicesession3@gmail.com"
          from: "Angular Deployment Bot"
          content_type: "text/html"
          body: |
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="UTF-8" />
              <style>
                body {font-family: Arial, sans-serif;background:#f4f6f8;margin:0;padding:0;}
                .container {background:#ffffff;width:90%;max-width:600px;margin:30px auto;border-radius:10px;
                            box-shadow:0 4px 12px rgba(0,0,0,0.1);padding:20px;}
                .header {background:#4CAF50;padding:15px;color:white;border-radius:10px 10px 0 0;text-align:center;font-size:22px;}
                .content {padding:20px;color:#333;line-height:1.6;}
                .btn {display:inline-block;padding:10px 20px;background:#4CAF50;color:white;border-radius:6px;text-decoration:none;margin-top:10px;}
                .footer {text-align:center;margin-top:20px;color:#777;font-size:12px;}
                .info-box {background:#f0f0f0;padding:10px;border-radius:6px;margin-top:10px;}
                .highlight {color:#4CAF50;font-weight:bold;}
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">üöÄ Angular Deployment Successful</div>
                <div class="content">
                  <p>Hello Raghu,</p>
                  <p>Your Angular project has been successfully deployed to Netlify! üéâ</p>

                  <div class="info-box">
                    <p><span class="highlight">Live URL:</span>
                      <a href="https://netlify-angular-frontend.netlify.app/" target="_blank">
                        https://netlify-angular-frontend.netlify.app/
                      </a>
                    </p>
                    <p><span class="highlight">Commit Message:</span> ${{ github.event.head_commit.message }}</p>
                    <p><span class="highlight">Commit Author:</span> ${{ github.event.head_commit.author.name }}</p>
                    <p><span class="highlight">Timestamp:</span> ${{ github.event.head_commit.timestamp }}</p>
                  </div>

                  <p>Click below to check the live deployment:</p>

                  <a class="btn" href="https://netlify-angular-frontend.netlify.app/" target="_blank">View Live App</a>

                  <p>If unexpected, please review workflow logs.</p>
                </div>

                <div class="footer">
                  Sent automatically by GitHub Actions ‚Äì Netlify CI/CD
                </div>
              </div>
            </body>
            </html>

      # 7Ô∏è‚É£ Email on Failure
      - name: Send Email Notification (Failure)
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Angular Deployment FAILED ‚Äì Netlify CI/CD"
          to: "practicesession3@gmail.com"
          from: "Angular Deployment Bot"
          content_type: "text/html"
          body: |
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="UTF-8" />
              <style>
                body {font-family: Arial, sans-serif;background:#ffeded;margin:0;padding:0;}
                .container {background:#ffffff;width:90%;max-width:600px;margin:30px auto;border-radius:10px;
                            box-shadow:0 4px 12px rgba(0,0,0,0.1);padding:20px;}
                .header {background:#d9534f;padding:15px;color:white;border-radius:10px 10px 0 0;text-align:center;font-size:22px;}
                .content {padding:20px;color:#333;line-height:1.6;}
                .footer {text-align:center;margin-top:20px;color:#777;font-size:12px;}
                .info-box {background:#ffe5e5;padding:10px;border-radius:6px;margin-top:10px;}
                .highlight {color:#d9534f;font-weight:bold;}
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">‚ùå Angular Deployment Failed</div>

                <div class="content">
                  <p>Hello Raghu,</p>
                  <p>Your Angular app deployment to Netlify has failed.</p>

                  <div class="info-box">
                    <p><span class="highlight">Commit Message:</span> ${{ github.event.head_commit.message }}</p>
                    <p><span class="highlight">Commit Author:</span> ${{ github.event.head_commit.author.name }}</p>
                  </div>

                  <p>Please check GitHub Actions logs to fix the issue.</p>
                </div>

                <div class="footer">
                  Sent automatically by GitHub Actions ‚Äì Netlify CI/CD
                </div>
              </div>
            </body>
            </html>
